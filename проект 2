В самом начале определяются две временные таблицы: "first_payments" и "all_dates". "first_payments" содержит информацию о первом успешном платеже каждого пользователя, а "all_dates" содержит все уникальные даты занятий (class_start_datetime) в заданном временном диапазоне (с 1 января 2016 года по 1 января 2017 года).
Затем создается временная таблица "all_dates_by_user", которая соединяет "all_dates" и "first_payments" и содержит пары (user_id, dt), где dt - дата занятия, начиная с даты первого успешного платежа пользователя.
Далее определяется временная таблица "payments_by_dates", которая содержит информацию о каждом успешном платеже пользователя, включая дату платежа и изменение баланса (transaction_balance_change).
В таблице "payments_by_dates_cumsum" производится кумулятивная сумма изменений баланса для каждого пользователя на каждую дату.
Затем определяется временная таблица "classes_by_dates", которая содержит информацию о количестве занятий (classes) для каждого пользователя на каждую дату.
В таблице "classes_by_dates_dates_cumsum" производится кумулятивная сумма количества занятий для каждого пользователя на каждую дату.
В конечной таблице "balances" объединяются результаты таблиц "payments_by_dates_cumsum" и "classes_by_dates_dates_cumsum" и вычисляется баланс (balance) пользователя на каждую дату путем сложения количества занятий и изменения баланса.
Наконец, основной запрос выбирает дату (dt) и суммы изменения баланса (sum_transaction_balance_change и sum_transaction_balance_change_cs), количества занятий (sum_classes и sum_classes_cs) и общего баланса (sum_balance) для всех пользователей, группируя результаты по дате и сортируя их по возрастанию даты.

https://metabase.sky.pro/question/73196
